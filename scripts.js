!function(a){a.Util={override:function(a,b,c){var d=a[b];a[b]=function(){var a=this.__super;this.__super=d;var b=c.apply(this,arguments);return this.__super=a,b}}}}(this),function(a){function b(){this.rest=100,this.energy=50,this.culture=0,this.athletics=0,this.education=0,this.profession=0,this.social=0}a.Stats=b}(this),function(a){function b(a){this.game=a,this._displayAmount=0,this._amount=0,this._pendingChanges=[]}_.extend(b.prototype,{add:function(a){var b=this._pendingChanges,c=this._amount;return 0===a?!0:0>c+a?!1:(b.push(a),!0)},subtract:function(a){return this.add(-a)},update:function(){var a=this._displayAmount,b=this._amount,c=this._pendingChanges;if(a==b&&c.length){var d=c.shift();b=this._amount=Math.max(b+d,0),this.game.add.tween(this).to({_displayAmount:b}).start()}}}),Object.defineProperty(b.prototype,"text",{get:function(){return"$"+Math.floor(this._displayAmount)}}),a.Wallet=b}(this),function(a){function b(a){this.time=a,this._events=[],this.onElapsedTime=new Phaser.Signal}b.prototype={update:function(a){for(var b=moment(a),c=this.nextEvent();c&&!c.isAfter(b);){var d=this._events.shift();d.recurring&&this._recurEvent(d),_.isFunction(d.callback)&&d.callback.call(d.context,c),c=this.nextEvent()}},nextEvent:function(){var a=this._events;return a.length?moment.unix(a[0].timestamp):void 0},add:function(a,b,c){if(this.time.now.isAfter(a))return!1;var d=_.uniqueId(),e={id:d};return this._addEvent(a,e,b,c)?d:!1},recurring:function(a,b,c){var d=this.time.pattern(a),e=_.uniqueId(),f={id:e,recurring:!0,pattern:a};return this._addEvent(d,f,b,c)?e:!1},cancel:function(a){var b=this._events,c=_.findIndex(b,{id:a});return c>-1?(b.splice(c,1),!0):!1},_addEvent:function(a,b,c,d){if(void 0===a)return!1;var e=this._events,f={timestamp:moment(a).unix(),callback:c,context:d},g=_.sortedIndex(e,f,"timestamp");return _.extend(f,b||{}),e.splice(g,0,f),!0},_recurEvent:function(a){if(a.recurring){var b=moment.unix(a.timestamp),c={id:a.id,recurring:!0,pattern:a.pattern};b=this.time.pattern(a.pattern,b),this._addEvent(b,c,a.callback,a.context)}}},a.SessionTimer=b}(this),function(a){function b(a){this.game=a,this._startedAt=moment("2014-04-28 6:00 AM","YYYY-MM-DD h:mm A"),this._now=moment(this._startedAt),this._displayNow=moment(this._now),this.events=new SessionTimer(this),this._pendingAdds=[],this._interpolator={}}var c=/^\s*([-a-z]{7})\s+(\d?\d:\d{2}\s+(?:am|pm))\s*$/i,d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];b.prototype={update:function(){var a=this._displayNow,b=this._now,c=this._pendingAdds,d=this._interpolator;if(b.isSame(a)){if(c.length){var e=c.shift(),f=Math.max(e.hours||0,0),g=Math.max(e.mins||0,0);if(0==f&&0==g)return;b.add("hours",f).add("minutes",g),d.time=a.unix();var h=b.clone(),i=game.add.tween(d).to({time:h.unix()});i.onComplete.addOnce(function(){this.events.update(h),this.events.onElapsedTime.dispatch(f,g,60*f+g),_.isFunction(e.callback)&&e.callback.call(e.context,h.clone())},this),i.start()}}else this._displayNow=moment.unix(d.time)},addTime:function(a,b,c,d){this._pendingAdds.push({hours:a,mins:b,callback:c,context:d})},weekday:function(a,b){var c=moment(a,"ddd h:mm A",!0);if(!c.isValid())return void 0;var d=c.day(),e=c.hour(),f=c.minute(),g=void 0===b?this.now:moment(b);return g.day()==d&&(g.hour()>e||g.hour()==e&&g.minute()>=f)&&(d+=7),g.day(d),g.hour(e),g.minute(f),g},nextScheduled:function(a,b){var e,f,g=void 0===b?this.now:moment(b),h=g.clone().startOf("week"),i=a.match(c);return i?(e=_(d).reject(function(a,b){return"-"==i[1][b]}).map(function(a){return this.weekday(a+" "+i[2],h)},this).valueOf(),_.isEmpty(e)?void 0:(f=_(e).sortBy(this._sortBy).sortedIndex(g,this._sortBy),f>=e.length?(e[0].add("week",1),e[0]):g.isBefore(e[f])?e[f]:(f++,f>=e.length?(e[0].add("week",1),e[0]):e[f]))):void 0},pattern:function(a,b){var c=this.nextScheduled(a,b);return void 0===c&&(c=this.weekday(a,b)),c},_sortBy:function(a){return a.unix()}},Object.defineProperty(b.prototype,"now",{get:function(){return moment(this._now)}}),Object.defineProperty(b.prototype,"week",{get:function(){var a=this._startedAt.get("isoweek"),b=this._now.get("isoweek");return b-a+1}}),Object.defineProperty(b.prototype,"text",{get:function(){var a=this._displayNow.format("ddd h:mm A");return"Week "+this.week+" "+a}}),a.SessionTime=b}(this),function(a){function b(a){this.game=a,this.time=new SessionTime(a),this.wallet=new Wallet(a),this.stats=new Stats,this.wallet.add(500)}b.prototype={update:function(){this.time.update(),this.wallet.update()}},a.Session=b}(this),function(a){function b(a){Phaser.Group.call(this,a,void 0,void 0,!0),this.addChild(a.make.tileSprite(0,0,640,30,"black")),this.addChild(this.timer=a.make.bitmapText(10,0,"minecraftia","",16)),this.addChild(this.money=a.make.bitmapText(290,0,"minecraftia","",16))}_.extend(b,{preload:function(a){a.image("black","assets/black.5fb519d0.png")}}),b.prototype=Object.create(Phaser.Group.prototype),b.prototype.constructor=b,Util.override(b.prototype,"update",function(){this.__super.apply(this,arguments);var a=this.game.session;this.timer.text=a.time.text,this.money.text=a.wallet.text}),a.HUD=b}(this),function(a){function b(a,c,d){Phaser.Sprite.call(this,a,c,d,"person"),this.anchor.setTo(.5,1),this.scale.setTo(8,8),this.smoothed=!1,this.animations.add("stand",[0]),this.animations.add("walk-right",[1,2,3,2],b.WALK_RATE,!0),this.animations.add("walk-left",[6,5,4,5],b.WALK_RATE,!0),this.animations.play("stand"),this.state="standing",a.physics.enable(this,Phaser.Physics.ARCADE),this.events.onArrived=new Phaser.Signal}b.preload=function(a){a.spritesheet("person","assets/person.430ad6c2.png",8,16,7)},_.extend(b,{WALK_RATE:3,SPEED:100,CLOSE_ENOUGH:8}),b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,_.extend(b.prototype,{think:function(){switch(this.state){case"walking":var a=this.x,c=this.destination;void 0===c||Math.abs(a-c)<b.CLOSE_ENOUGH?(this.stand(),void 0!==c&&(this.events.onArrived.dispatch(),this.destination=void 0)):c>a?this.walk(Phaser.RIGHT):a>c&&this.walk(Phaser.LEFT)}},stand:function(){this.body.velocity.x=0,this.animations.play("stand"),this.state="standing"},walk:function(a){switch(a){case Phaser.LEFT:this.body.velocity.x=-b.SPEED,this.animations.play("walk-left"),this.state="walking";break;case Phaser.RIGHT:this.body.velocity.x=b.SPEED,this.animations.play("walk-right"),this.state="walking";break;default:this.stand()}},"goto":function(a){this.destination=a,this.state="walking"}}),a.Actor=b}(this),function(a){function b(a,b,c,d){Phaser.Sprite.call(this,a,b,c,"background-door"),this.anchor.setTo(.5,1),this.frame=d||0,this.smoothed=!1,this.scale.setTo(4,4),this.inputEnabled=!0}_.extend(b,{preload:function(a){a.spritesheet("background-door","assets/background doors.0eadbc6e.png",16,32)}}),b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,_.extend(b.prototype,{}),a.Door=b}(this),function(a){function b(a,c){this.game=a;var d=a.add.tilemap();d.addTilesetImage("home-walls",void 0,16,64);var e=this.layer=d.create("walls",c+2*b.OFFSET,1,16,64);e.smoothed=!1,e.scale.setTo(4,4),e.fixedToCamera=!1;for(var f=b.OFFSET;f<c+b.OFFSET;f++)d.putTile(b.Constants.EMPTY_WALL,f,0);d.putTile(b.Constants.LEFT_WALL,b.OFFSET,0),d.putTile(b.Constants.RIGHT_WALL,c+b.OFFSET,0),a.world.setBounds(0,0,64*(2*b.OFFSET+c),480)}_.extend(b,{Constants:{LEFT_WALL:0,EMPTY_WALL:1,WINDOW:2,RIGHT_WALL:3},OFFSET:2,preload:function(a){a.image("home-walls","assets/home walls.ab8673f4.png")}}),a.IndoorWalls=b}(this),function(a){function b(a,b,c,d,e){Phaser.Sprite.call(this,a,b,c,d),this.anchor.setTo(.5,1),this.scale.setTo(4,4),void 0!==e&&(this.frame=e),this.smoothed=!1,this.inputEnabled=!0}b.preload=function(a){a.spritesheet("background-door","assets/background doors.0eadbc6e.png",16,32),a.image("bed","assets/bed.d702ae45.png")},b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,a.SceneObject=b}(this),function(a){function b(){}b.prototype={create:function(){var a=this.game,b=this.add,c=this.player=new Actor(this.game,240,250);new IndoorWalls(a,10);var d=this.background=b.group();b.existing(c);this.foreground=b.group();this.input.onDown.add(this.onDown,this),d.add(new Door(this.game,480,228)),d.add(new SceneObject(this.game,240,240,"bed")),a.HUD||(a.HUD=new HUD(a)),a.camera.follow(c)},update:function(){this.game.session.update(),this.player.think()},render:function(){game.debug.cameraInfo(game.camera,32,300)},onDown:function(a){var b=a.worldX;this.player.goto(b)}},a.Scene=b}(this),function(a){function b(a){this.game=a,this.map=this.createMap()}function c(a,b,c){var d,e,f;for(d=0;100>d&&(e=a.integerInRange(0,3),f=a.integerInRange(0,3),0!=b[e][f]);d++);b[e][f]=c}function d(a,b,d,e,f){var g=a.integerInRange(e,f),h=_.partial(c,a,b,d);_.times(g,h)}b.Constants={NEIGHBORHOOD:0,PARK:1,STRIP_MALL:2,OFFICES:3,HOSPITAL:4},b.preload=function(a){a.image("building-tiles","assets/building tiles rough.5f4545c0.png")},b.prototype={createMap:function(){var a=this.game.rnd,c=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],e=_.partial(d,a,c);return e(b.Constants.OFFICES,2,4),e(b.Constants.STRIP_MALL,2,4),e(b.Constants.PARK,1,2),e(b.Constants.HOSPITAL,1,1),c},createTileMap:function(){var a=this.game.add.tilemap();a.addTilesetImage("building-tiles",void 0,120,120);for(var b=(a.create("buildings",4,4,120,120),0);4>b;b++)for(var c=0;4>c;c++)a.putTile(this.map[b][c],b,c);return a}},a.Town=b}(this),function(a){function b(){}b.prototype={},a.TownScreen=b}(this),function(a){function b(){}b.prototype={preload:function(){this.load.image("loading-bar","assets/loading bar.84d69c42.png"),this.load.image("loading-bar-overlay","assets/loading bar overlay.85346d32.png")},create:function(){this.stage.backgroundColor="#000000",this.state.start("preload")}},a.Boot=b}(this),function(a){function b(){}b.prototype={preload:function(){var a=this.load,b=this.add,c=b.sprite(192,232,"loading-bar");b.sprite(192,232,"loading-bar-overlay"),a.setPreloadSprite(c),a.onLoadComplete.addOnce(this.onLoadComplete,this),IndoorWalls.preload(a),SceneObject.preload(a),HUD.preload(a),Town.preload(a),Actor.preload(a),Door.preload(a),a.bitmapFont("minecraftia","assets/minecraftia.d0c5b06a.png","assets/minecraftia.ddf29ec1.xml")},onLoadComplete:function(){this.state.start("game")}},a.Preload=b}(this),function(){function a(){}a.prototype={create:function(){{var a=(this.add,this.town=new Town(this.game));this.townMap=a.createTileMap()}}},this.Game=a}(this),function(a){function b(){}b.prototype={preload:function(){this.load.bitmapFont("minecraftia","assets/minecraftia.d0c5b06a.png","assets/minecraftia.ddf29ec1.xml")},create:function(){var a=this.game.session,b=a.time,c=function(a){console.log(a.format())};console.log("expect 2 times"),b.events.add(b.weekday("Mon 7:00 AM"),c),b.events.add(b.weekday("Mon 6:15 AM"),c),b.events.update(b.weekday("Mon 7:00 AM")),console.log("expect 3 times"),b.events.recurring("Tues 12:00 PM",c),b.events.update(b.now.add("weeks",3)),console.log("expect 4-30");var d="---W--- 1:45 PM",e=b.nextScheduled(d,b.weekday("Mon 7:00 AM"));console.log(e.format()),console.log("expect 5-7"),e=b.nextScheduled(d,b.weekday("Wed 1:46 PM")),console.log(e.format()),d="-M-W-F- 12:00 PM",console.log("expect 4-28"),console.log(b.nextScheduled(d,b.weekday("Sun 12:00 PM")).format()),console.log("expect 4-30"),console.log(b.nextScheduled(d,b.weekday("Tue 12:00 PM")).format()),console.log("expect 5-2"),console.log(b.nextScheduled(d,b.weekday("Thu 12:00 PM")).format()),console.log("expect 5-5"),console.log(b.nextScheduled(d,b.weekday("Sat 12:00 PM")).format()),console.log("expect nothing"),b.events.recurring("------- 7:00 pm",c),b.events.update(b.now.add("weeks",1)),console.log("expect 7 times"),b.events.recurring("SMTWTFS 5:45 AM",c),b.events.update(b.now.add("weeks",1));var f=(this.timer=this.add.bitmapText(10,0,"minecraftia",b.text,16),this.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR));f.onDown.add(function(){console.log("pressed space"),b.addTime(0,15,function(a){console.log("time is now: "+a.format())})}),this.input.keyboard.addKeyCapture(Phaser.Keyboard.SPACEBAR)},update:function(){var a=this.game.session,b=this.timer;a.update(),b.text=a.time.text}},a.SessionTimeTest=b}(this),function(a){function b(a){Phaser.Game.call(this,640,480,Phaser.AUTO,a),this.state.add("boot",Boot),this.state.add("preload",Preload),this.state.add("game",Scene),this.state.add("time-test",SessionTimeTest),this.session=new Session(this)}b.prototype=Object.create(Phaser.Game.prototype),b.prototype.constructor=b,a.TownGame=b}(this);var game=new TownGame("game-container");game.state.start("boot");